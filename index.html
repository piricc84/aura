<!doctype html>
<html lang="it">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <meta name="theme-color" content="#0B1220" />
  <link rel="manifest" href="./manifest.webmanifest" />
  <link rel="apple-touch-icon" href="./icons/icon-192.png" />
  <title>AURA</title>
  <style>
    :root{
      --bg0:#070B14;
      --bg1:#0B1220;
      --bg2:#0F1B2F;
      --card:rgba(255,255,255,.06);
      --card2:rgba(255,255,255,.09);
      --stroke:rgba(255,255,255,.10);
      --text:#F3F6FF;
      --muted:rgba(243,246,255,.72);
      --muted2:rgba(243,246,255,.55);
      --accent:#4D8CFF;
      --accent2:#6AE3B4;
      --warn:#FFB86B;
      --shadow: 0 18px 50px rgba(0,0,0,.45);
      --r:18px;
      --safeT: env(safe-area-inset-top, 0px);
      --safeB: env(safe-area-inset-bottom, 0px);
      --safeL: env(safe-area-inset-left, 0px);
      --safeR: env(safe-area-inset-right, 0px);
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0;
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial;
      color:var(--text);
      background: radial-gradient(1200px 800px at 20% 0%, rgba(77,140,255,.20), transparent 60%),
                  radial-gradient(900px 700px at 100% 20%, rgba(106,227,180,.14), transparent 55%),
                  radial-gradient(800px 600px at 30% 110%, rgba(255,184,107,.12), transparent 55%),
                  linear-gradient(180deg, var(--bg0), var(--bg1));
      overflow:hidden;
      -webkit-font-smoothing:antialiased;
    }
    a{color:inherit}
    button{font:inherit}

    /* Layout: single-page always visible */
    .app{
      height:100%;
      display:flex;
      flex-direction:column;
      padding: calc(12px + var(--safeT)) calc(14px + var(--safeR)) calc(12px + var(--safeB)) calc(14px + var(--safeL));
      gap:12px;
    }
    .topbar{
      display:flex; align-items:center; justify-content:space-between;
      gap:10px;
      padding: 2px 2px 0;
      min-height:52px;
    }
    .brand{
      display:flex; align-items:center; gap:10px;
    }
    .logo{
      width:40px;height:40px;border-radius:14px;
      background: radial-gradient(circle at 30% 30%, rgba(255,255,255,.26), rgba(255,255,255,.06) 55%, rgba(255,255,255,.02)),
                  linear-gradient(135deg, rgba(77,140,255,.75), rgba(106,227,180,.20));
      display:grid; place-items:center;
      box-shadow: 0 14px 28px rgba(0,0,0,.35);
      position:relative;
      overflow:hidden;
    }
    .logo:before{
      content:"";
      position:absolute; inset:-40%;
      background: conic-gradient(from 90deg, rgba(77,140,255,.0), rgba(77,140,255,.55), rgba(106,227,180,.45), rgba(77,140,255,.0));
      animation: spin 6s linear infinite;
      filter: blur(0.5px);
    }
    .logo:after{
      content:"";
      position:absolute; inset:4px;
      background: linear-gradient(180deg, rgba(11,18,32,.78), rgba(7,11,20,.65));
      border-radius:12px;
    }
    .logo span{
      position:relative; z-index:1;
      font-weight:900; letter-spacing:.6px;
      color: var(--text);
      font-size:14px;
    }
    @keyframes spin { to { transform: rotate(360deg); } }

    .titlewrap{display:flex; flex-direction:column; line-height:1.05}
    .titlewrap .t{font-size:18px;font-weight:900; letter-spacing:.2px}
    .titlewrap .s{font-size:12px;color:var(--muted2); margin-top:2px}

    .top-actions{display:flex; gap:8px; align-items:center}
    .iconbtn{
      height:40px; width:40px;
      border-radius:14px;
      border:1px solid var(--stroke);
      background: rgba(255,255,255,.06);
      color:var(--text);
      box-shadow: 0 12px 26px rgba(0,0,0,.25);
      cursor:pointer;
      display:grid; place-items:center;
      transition: transform .12s ease, background .15s ease;
      -webkit-tap-highlight-color: transparent;
    }
    .iconbtn:active{ transform: scale(.97); }

    /* Home: everything visible without navigation */
    .content{
      flex:1;
      display:grid;
      grid-template-rows: auto auto 1fr;
      gap:12px;
      min-height:0;
    }

    .hero{
      border:1px solid var(--stroke);
      background: linear-gradient(180deg, rgba(255,255,255,.08), rgba(255,255,255,.05));
      border-radius: var(--r);
      padding: 14px;
      box-shadow: var(--shadow);
      position:relative;
      overflow:hidden;
    }
    .hero:before{
      content:"";
      position:absolute; inset:-2px;
      background: radial-gradient(500px 220px at 15% 10%, rgba(77,140,255,.25), transparent 60%),
                  radial-gradient(460px 220px at 85% 30%, rgba(106,227,180,.16), transparent 60%);
      pointer-events:none;
    }
    .hero .row{display:flex; align-items:flex-start; justify-content:space-between; gap:12px; position:relative}
    .hero h1{margin:0; font-size:18px; font-weight:900; letter-spacing:.2px}
    .hero p{margin:6px 0 0; font-size:13px; color:var(--muted); line-height:1.35}
    .chip{
      display:inline-flex; align-items:center; gap:6px;
      padding:8px 10px;
      border:1px solid rgba(255,255,255,.12);
      background: rgba(7,11,20,.25);
      border-radius: 999px;
      font-size:12px;
      color:var(--muted);
      white-space:nowrap;
      user-select:none;
    }
    .chip b{color:var(--text)}
    .hero .cta{
      margin-top:12px;
      display:flex; gap:8px; flex-wrap:wrap;
      position:relative;
    }
    .btn{
      border:none;
      border-radius: 14px;
      padding: 12px 14px;
      cursor:pointer;
      color: var(--text);
      background: rgba(255,255,255,.08);
      border:1px solid rgba(255,255,255,.10);
      transition: transform .12s ease, background .15s ease;
      -webkit-tap-highlight-color: transparent;
      display:inline-flex;
      align-items:center;
      gap:10px;
      font-weight:800;
      font-size:13px;
    }
    .btn.primary{
      background: linear-gradient(135deg, rgba(77,140,255,.92), rgba(106,227,180,.20));
      border: 1px solid rgba(255,255,255,.14);
    }
    .btn.ghost{ background: rgba(255,255,255,.06); }
    .btn:active{ transform: scale(.985); }
    .btn small{font-weight:800; opacity:.85}

    .grid{
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap:10px;
      min-height:0;
    }
    .card{
      border:1px solid rgba(255,255,255,.10);
      background: rgba(255,255,255,.06);
      border-radius: var(--r);
      padding: 12px;
      box-shadow: 0 14px 38px rgba(0,0,0,.35);
      cursor:pointer;
      position:relative;
      overflow:hidden;
      min-height: 96px;
      display:flex;
      flex-direction:column;
      justify-content:space-between;
      -webkit-tap-highlight-color: transparent;
      transition: transform .12s ease, background .15s ease;
    }
    .card:active{ transform: scale(.985); }
    .card:before{
      content:"";
      position:absolute; inset:-2px;
      background: radial-gradient(220px 160px at 10% 0%, rgba(77,140,255,.22), transparent 55%),
                  radial-gradient(220px 160px at 100% 30%, rgba(106,227,180,.14), transparent 55%);
      pointer-events:none;
      opacity:.9;
    }
    .card .k{position:relative; display:flex; align-items:center; justify-content:space-between; gap:10px}
    .card .k .ttl{font-weight:900; letter-spacing:.1px}
    .card .k .ico{
      width:36px; height:36px;
      border-radius:14px;
      border:1px solid rgba(255,255,255,.12);
      background: rgba(7,11,20,.18);
      display:grid; place-items:center;
      flex: 0 0 auto;
    }
    .card .d{position:relative; color:var(--muted); font-size:12px; line-height:1.32; margin-top:8px}
    .card .hint{position:relative; margin-top:10px; font-size:11px; color:var(--muted2); display:flex; align-items:center; gap:6px}
    .dot{width:6px;height:6px;border-radius:99px;background: rgba(106,227,180,.9)}
    .dot.warn{background: rgba(255,184,107,.95)}
    .dot.blue{background: rgba(77,140,255,.95)}

    /* Bottom music banner (collapsible) */
    .musicbar{
      border:1px solid rgba(255,255,255,.10);
      background: rgba(255,255,255,.06);
      border-radius: 22px;
      padding: 10px;
      box-shadow: var(--shadow);
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
      min-height: 56px;
      position:relative;
      overflow:hidden;
    }
    .musicbar:before{
      content:"";
      position:absolute; inset:-2px;
      background: radial-gradient(300px 180px at 10% 0%, rgba(77,140,255,.22), transparent 60%),
                  radial-gradient(300px 180px at 100% 50%, rgba(106,227,180,.14), transparent 60%);
      pointer-events:none;
      opacity:.9;
    }
    .musicleft{position:relative; display:flex; align-items:center; gap:10px; min-width:0}
    .pill{
      width:40px;height:40px;border-radius:16px;
      border:1px solid rgba(255,255,255,.12);
      background: rgba(7,11,20,.22);
      display:grid; place-items:center;
      cursor:pointer;
      -webkit-tap-highlight-color: transparent;
      transition: transform .12s ease;
    }
    .pill:active{transform:scale(.97)}
    .musicmeta{position:relative; display:flex; flex-direction:column; min-width:0}
    .musicmeta .m1{font-size:12px;font-weight:900; letter-spacing:.15px; white-space:nowrap; overflow:hidden; text-overflow:ellipsis}
    .musicmeta .m2{font-size:11px;color:var(--muted2); white-space:nowrap; overflow:hidden; text-overflow:ellipsis}
    .musicright{position:relative; display:flex; align-items:center; gap:8px}
    .minibtn{
      height:40px; min-width:40px;
      padding:0 12px;
      border-radius:16px;
      border:1px solid rgba(255,255,255,.12);
      background: rgba(7,11,20,.18);
      color:var(--text);
      cursor:pointer;
      font-weight:900;
      font-size:12px;
      -webkit-tap-highlight-color: transparent;
      transition: transform .12s ease;
    }
    .minibtn:active{transform:scale(.985)}
    .select{
      height:40px;
      border-radius:16px;
      border:1px solid rgba(255,255,255,.12);
      background: rgba(7,11,20,.18);
      color:var(--text);
      font-weight:900;
      font-size:12px;
      padding:0 12px;
      outline:none;
      max-width: 160px;
    }

    /* Modal */
    .modal-backdrop{
      position:fixed; inset:0;
      background: rgba(0,0,0,.55);
      backdrop-filter: blur(8px);
      display:none;
      z-index:50;
      padding: calc(10px + var(--safeT)) calc(10px + var(--safeR)) calc(12px + var(--safeB)) calc(10px + var(--safeL));
    }
    .modal-backdrop.show{display:block; animation: fade .18s ease}
    @keyframes fade { from{opacity:0} to{opacity:1} }

    .modal{
      height:100%;
      display:flex;
      align-items:flex-end;
      justify-content:center;
    }
    .sheet{
      width:100%;
      max-width: 520px;
      max-height: 92vh;
      background: linear-gradient(180deg, rgba(15,27,47,.92), rgba(11,18,32,.92));
      border:1px solid rgba(255,255,255,.10);
      border-radius: 26px;
      box-shadow: 0 24px 70px rgba(0,0,0,.55);
      overflow:hidden;
      display:flex;
      flex-direction:column;
      transform: translateY(10px);
      animation: pop .18s ease forwards;
    }
    @keyframes pop { to{ transform: translateY(0) } }
    .sheet-h{
      padding: 14px 14px 10px;
      display:flex; align-items:center; justify-content:space-between; gap:10px;
      border-bottom: 1px solid rgba(255,255,255,.08);
    }
    .sheet-h .sh-title{font-weight:900}
    .sheet-h .sh-sub{font-size:12px; color:var(--muted2); margin-top:2px}
    .sheet-h .x{height:36px;width:36px;border-radius:14px;border:1px solid rgba(255,255,255,.12);background:rgba(255,255,255,.06);cursor:pointer;color:var(--text)}
    .sheet-b{
      padding: 12px 14px 14px;
      overflow:auto;
      -webkit-overflow-scrolling: touch;
    }
    .row2{display:grid; grid-template-columns: 1fr 1fr; gap:10px}
    .field{
      background: rgba(255,255,255,.06);
      border: 1px solid rgba(255,255,255,.10);
      border-radius: 16px;
      padding: 10px 12px;
    }
    .field label{display:block; font-size:11px; color:var(--muted2); font-weight:900; letter-spacing:.3px}
    .field input, .field textarea{
      width:100%;
      margin-top:6px;
      background: transparent;
      border:none;
      color:var(--text);
      outline:none;
      font-size:13px;
      font-weight:800;
      resize:none;
    }
    .field textarea{min-height:88px; font-weight:700; line-height:1.35}
    .seg{
      display:flex; gap:8px; flex-wrap:wrap;
      margin-top:10px;
    }
    .tag{
      padding:10px 12px;
      border-radius: 999px;
      border: 1px solid rgba(255,255,255,.10);
      background: rgba(255,255,255,.06);
      cursor:pointer;
      font-weight:900;
      font-size:12px;
    }
    .tag.on{background: rgba(106,227,180,.16); border-color: rgba(106,227,180,.28)}
    .tag.blue.on{background: rgba(77,140,255,.18); border-color: rgba(77,140,255,.28)}
    .tag.warn.on{background: rgba(255,184,107,.16); border-color: rgba(255,184,107,.28)}
    .divider{height:1px; background: rgba(255,255,255,.08); margin:12px 0}
    .small{font-size:12px;color:var(--muted); line-height:1.45}
    .list{display:flex; flex-direction:column; gap:10px}
    .entry{
      border:1px solid rgba(255,255,255,.10);
      background: rgba(255,255,255,.06);
      border-radius: 16px;
      padding: 12px;
    }
    .entry .h{display:flex; align-items:center; justify-content:space-between; gap:10px}
    .entry .h b{font-size:13px}
    .entry .h span{font-size:11px;color:var(--muted2)}
    .entry p{margin:8px 0 0; font-size:12px; color:var(--muted); line-height:1.4}
    .danger{color:#FFD1D1}
    .kbd{font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas; font-size:11px; padding:2px 6px; border-radius:8px; border:1px solid rgba(255,255,255,.10); background: rgba(0,0,0,.25)}

    /* Onboarding */
    .onb{
      position:fixed; inset:0;
      background: rgba(0,0,0,.55);
      backdrop-filter: blur(10px);
      display:none;
      z-index:80;
      padding: calc(14px + var(--safeT)) calc(14px + var(--safeR)) calc(14px + var(--safeB)) calc(14px + var(--safeL));
    }
    .onb.show{display:block}
    .onb-card{
      max-width: 520px;
      margin: 0 auto;
      background: linear-gradient(180deg, rgba(15,27,47,.92), rgba(11,18,32,.92));
      border: 1px solid rgba(255,255,255,.10);
      border-radius: 26px;
      box-shadow: 0 28px 80px rgba(0,0,0,.6);
      padding: 16px;
      position:relative;
      overflow:hidden;
    }
    .onb-card:before{
      content:"";
      position:absolute; inset:-2px;
      background: radial-gradient(520px 260px at 15% 10%, rgba(77,140,255,.22), transparent 60%),
                  radial-gradient(480px 240px at 90% 40%, rgba(106,227,180,.16), transparent 60%);
      pointer-events:none;
      opacity:.95;
    }
    .onb-card .inner{position:relative}
    .onb-title{font-weight:1000; font-size:18px; margin:0}
    .onb-sub{margin:8px 0 0; color:var(--muted); font-size:13px; line-height:1.4}
    .steps{margin-top:12px; display:flex; flex-direction:column; gap:10px}
    .step{
      border:1px solid rgba(255,255,255,.10);
      background: rgba(255,255,255,.06);
      border-radius: 18px;
      padding: 12px;
      display:flex; gap:10px; align-items:flex-start;
    }
    .num{
      width:28px; height:28px; border-radius:12px;
      display:grid; place-items:center;
      font-weight:1000;
      background: rgba(77,140,255,.22);
      border:1px solid rgba(77,140,255,.28);
      flex: 0 0 auto;
    }
    .step b{display:block; font-size:13px; margin-top:1px}
    .step p{margin:4px 0 0; font-size:12px; color:var(--muted); line-height:1.35}
    .onb-actions{margin-top:12px; display:flex; gap:10px; flex-wrap:wrap}
    .onb-actions .btn{flex:1}
    .onb-actions .btn.ghost{flex:1}
  </style>
</head>
<body>
  <div class="app" id="app">
    <div class="topbar">
      <div class="brand">
        <div class="logo" aria-hidden="true"><span>A</span></div>
        <div class="titlewrap">
          <div class="t">AURA</div>
          <div class="s" id="subtitle">Un minuto per tornare a te.</div>
        </div>
      </div>
      <div class="top-actions">
        <button class="iconbtn" id="btnHelp" aria-label="Aiuto">?</button>
        <button class="iconbtn" id="btnInstall" aria-label="Installa">‚á©</button>
      </div>
    </div>

    <div class="content">
      <div class="hero">
        <div class="row">
          <div>
            <h1 id="heroTitle">Bentornato.</h1>
            <p id="heroText">Scegli un micro‚Äërituale. AURA ti guida con suoni morbidi, vibrazioni leggere e piccoli suggerimenti.</p>
            <div style="margin-top:10px; display:flex; gap:8px; flex-wrap:wrap">
              <span class="chip">Stato: <b id="chipState">Calmo</b></span>
              <span class="chip">Oggi: <b id="chipStreak">0</b> note</span>
              <span class="chip">Audio: <b id="chipAudio">Off</b></span>
            </div>
          </div>
          <div class="chip" id="softTip" title="Suggerimento delicato">
            ‚ú® <span id="tipText">Respira 4‚Äë4‚Äë6 per 60 secondi.</span>
          </div>
        </div>
        <div class="cta">
          <button class="btn primary" id="btnStart60">‚ñ∂ <span>Rituale 60s</span></button>
          <button class="btn ghost" id="btnBreath">ü´Å <span>Respiro guidato</span></button>
          <button class="btn ghost" id="btnJournal">‚úçÔ∏è <span>Diario</span></button>
        </div>
      </div>

      <div class="grid">
        <div class="card" id="cardSounds" role="button" aria-label="Suoni">
          <div class="k">
            <div class="ttl">Suoni</div>
            <div class="ico">‚ô´</div>
          </div>
          <div class="d">Ambienti rilassanti generati offline (niente ‚Äúsuono fisso‚Äù).</div>
          <div class="hint"><span class="dot blue"></span> audio morbido</div>
        </div>

        <div class="card" id="cardInsight" role="button" aria-label="Insight">
          <div class="k">
            <div class="ttl">Insight</div>
            <div class="ico">üìà</div>
          </div>
          <div class="d">Vedi trend, orari migliori e cosa ti calma davvero.</div>
          <div class="hint"><span class="dot"></span> 7 giorni</div>
        </div>

        <div class="card" id="cardRitual" role="button" aria-label="Rituali">
          <div class="k">
            <div class="ttl">Rituali</div>
            <div class="ico">üß≠</div>
          </div>
          <div class="d">Mini‚Äëscelte: focus, calma, energia gentile.</div>
          <div class="hint"><span class="dot"></span> guidati</div>
        </div>

        <div class="card" id="cardSettings" role="button" aria-label="Impostazioni">
          <div class="k">
            <div class="ttl">Impostazioni</div>
            <div class="ico">‚öôÔ∏è</div>
          </div>
          <div class="d">Vibrazione, volume, suggerimenti, privacy.</div>
          <div class="hint"><span class="dot warn"></span> personalizza</div>
        </div>
      </div>

      <div class="musicbar" id="musicBar" aria-label="Barra musica">
        <div class="musicleft">
          <div class="pill" id="btnMusicToggle" title="Play/Pausa" aria-label="Play/Pausa">‚ñ∂</div>
          <div class="musicmeta">
            <div class="m1" id="musicName">Ambiente: Onda</div>
            <div class="m2" id="musicStatus">Tocca Play per avviare (iPhone richiede un tocco).</div>
          </div>
        </div>
        <div class="musicright">
          <select class="select" id="musicSelect" aria-label="Seleziona ambiente">
            <option value="ocean">Onda</option>
            <option value="rain">Pioggia</option>
            <option value="forest">Foresta</option>
            <option value="space">Deep Focus</option>
          </select>
          <button class="minibtn" id="btnMusicMore" aria-label="Dettagli">‚â°</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Onboarding / Demo -->
  <div class="onb" id="onb">
    <div class="onb-card">
      <div class="inner">
        <h2 class="onb-title">Benvenuto in AURA ‚ú®</h2>
        <div class="onb-sub">
          30 secondi di demo e sei operativo. Audio morbido, rituali rapidi, diario leggero. Tutto offline.
        </div>
        <div class="steps" id="onbSteps">
          <div class="step">
            <div class="num">1</div>
            <div>
              <b>Avvia l‚Äôaudio</b>
              <p>Premi <span class="kbd">‚ñ∂</span> in basso. Su iPhone l‚Äôaudio parte solo dopo un tocco: √® normale.</p>
            </div>
          </div>
          <div class="step">
            <div class="num">2</div>
            <div>
              <b>Scegli un rituale</b>
              <p><span class="kbd">Rituale 60s</span> ti guida con respiro + feedback morbidi.</p>
            </div>
          </div>
          <div class="step">
            <div class="num">3</div>
            <div>
              <b>Lascia una nota</b>
              <p>Apri <span class="kbd">Diario</span> e salva 1 riga. AURA costruisce i tuoi insight.</p>
            </div>
          </div>
        </div>
        <div class="onb-actions">
          <button class="btn primary" id="onbGo">Ok, iniziamo</button>
          <button class="btn ghost" id="onbSkip">Salta</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Modal -->
  <div class="modal-backdrop" id="modalBack">
    <div class="modal" role="dialog" aria-modal="true">
      <div class="sheet" id="sheet">
        <div class="sheet-h">
          <div>
            <div class="sh-title" id="sheetTitle">Titolo</div>
            <div class="sh-sub" id="sheetSub">Sottotitolo</div>
          </div>
          <button class="x" id="sheetClose" aria-label="Chiudi">‚úï</button>
        </div>
        <div class="sheet-b" id="sheetBody"></div>
      </div>
    </div>
  </div>

<script>
(() => {
  const $ = (id) => document.getElementById(id);
  const state = {
    audioOn: false,
    audioEnv: 'ocean',
    audioVol: 0.35,
    fxVol: 0.25,
    haptics: true,
    tips: true,
    entries: [],
    lastTipAt: 0,
    installPrompt: null,
    audioCtx: null,
    nodes: null,
  };

  // --- Persistence
  const LS_KEY = 'aura.v3.2.1';
  function load(){
    try{
      const raw = localStorage.getItem(LS_KEY);
      if(!raw) return;
      const obj = JSON.parse(raw);
      Object.assign(state, obj);
      state.audioCtx = null;
      state.nodes = null;
    }catch(e){}
  }
  function save(){
    const {audioCtx, nodes, installPrompt, ...persist} = state;
    localStorage.setItem(LS_KEY, JSON.stringify(persist));
  }

  // --- Soft FX (WebAudio, no harsh clicks)
  function fxEnsure(){
    if(state.audioCtx) return state.audioCtx;
    const Ctx = window.AudioContext || window.webkitAudioContext;
    if(!Ctx) return null;
    state.audioCtx = new Ctx();
    return state.audioCtx;
  }
  function fxHaptic(ms=8){
    if(!state.haptics) return;
    if(navigator.vibrate) navigator.vibrate(ms); // iOS Safari: no-op (ok)
  }

  function fxClick(){
    const ctx = fxEnsure();
    if(!ctx) return;
    // Gentle marimba-ish: sine + slight detune, very short
    const t = ctx.currentTime;
    const o = ctx.createOscillator();
    const g = ctx.createGain();
    const f = ctx.createBiquadFilter();
    f.type = 'lowpass';
    f.frequency.setValueAtTime(1400, t);
    f.Q.setValueAtTime(0.7, t);
    o.type = 'sine';
    o.frequency.setValueAtTime(440, t);
    o.detune.setValueAtTime((Math.random()*8-4), t);

    g.gain.setValueAtTime(0.0001, t);
    g.gain.exponentialRampToValueAtTime(Math.max(0.0001, state.fxVol)*0.35, t+0.01);
    g.gain.exponentialRampToValueAtTime(0.0001, t+0.10);

    o.connect(f); f.connect(g); g.connect(ctx.destination);
    o.start(t);
    o.stop(t+0.12);
  }

  function fxSuccess(){
    const ctx = fxEnsure();
    if(!ctx) return;
    const t = ctx.currentTime;
    const g = ctx.createGain();
    g.gain.setValueAtTime(0.0001, t);
    g.gain.exponentialRampToValueAtTime(Math.max(0.0001, state.fxVol)*0.45, t+0.01);
    g.gain.exponentialRampToValueAtTime(0.0001, t+0.18);

    const o1 = ctx.createOscillator();
    const o2 = ctx.createOscillator();
    o1.type = 'sine'; o2.type = 'sine';
    o1.frequency.setValueAtTime(523.25, t);
    o2.frequency.setValueAtTime(659.25, t);
    o1.connect(g); o2.connect(g); g.connect(ctx.destination);
    o1.start(t); o2.start(t+0.02);
    o1.stop(t+0.20); o2.stop(t+0.20);
  }

  // --- Ambient audio engine (no fixed harsh tone)
  function buildAmbient(ctx, env){
    // Master
    const master = ctx.createGain();
    master.gain.value = 0.0001;
    master.connect(ctx.destination);

    // Soft compressor to avoid peaks
    const comp = ctx.createDynamicsCompressor();
    comp.threshold.value = -22;
    comp.knee.value = 18;
    comp.ratio.value = 3;
    comp.attack.value = 0.015;
    comp.release.value = 0.20;
    comp.connect(master);

    // Noise source (buffer loop)
    const nlen = Math.floor(ctx.sampleRate * 2);
    const nb = ctx.createBuffer(1, nlen, ctx.sampleRate);
    const d = nb.getChannelData(0);
    for(let i=0;i<nlen;i++){
      d[i] = (Math.random()*2-1);
    }
    const ns = ctx.createBufferSource();
    ns.buffer = nb;
    ns.loop = true;

    const nf = ctx.createBiquadFilter();
    nf.type = 'lowpass';
    nf.frequency.value = 1200;
    nf.Q.value = 0.8;

    const ng = ctx.createGain();
    ng.gain.value = 0.15;

    // Add gentle "brownish" feel via integrator
    // (implemented as lowpass + gain staging; enough to remove hiss)
    ns.connect(nf);
    nf.connect(ng);
    ng.connect(comp);

    // Pad: 3 detuned sines through lowpass
    const pad = ctx.createGain();
    pad.gain.value = 0.12;
    const pf = ctx.createBiquadFilter();
    pf.type = 'lowpass';
    pf.frequency.value = 900;
    pf.Q.value = 0.5;
    pad.connect(pf); pf.connect(comp);

    function mkOsc(freq, det){
      const o = ctx.createOscillator();
      o.type = 'sine';
      o.frequency.value = freq;
      o.detune.value = det;
      const g = ctx.createGain();
      g.gain.value = 0.0001;
      o.connect(g); g.connect(pad);
      return {o,g};
    }
    const base = (env === 'space') ? 110 : (env === 'forest' ? 140 : 125);
    const oA = mkOsc(base, -7);
    const oB = mkOsc(base*1.5, +5);
    const oC = mkOsc(base*2.0, -3);

    // Slow LFO for movement
    const lfo = ctx.createOscillator();
    lfo.type = 'sine';
    lfo.frequency.value = 0.08;
    const lfoGain = ctx.createGain();
    lfoGain.gain.value = 160; // affects filter cutoff
    lfo.connect(lfoGain);
    lfoGain.connect(nf.frequency);

    const lfo2 = ctx.createOscillator();
    lfo2.type = 'sine';
    lfo2.frequency.value = 0.05;
    const lfo2Gain = ctx.createGain();
    lfo2Gain.gain.value = 0.06; // pad volume
    lfo2.connect(lfo2Gain);
    lfo2Gain.connect(pad.gain);

    // Env profiles
    if(env === 'rain'){
      nf.frequency.value = 950;
      ng.gain.value = 0.18;
      pf.frequency.value = 700;
      pad.gain.value = 0.10;
    } else if(env === 'forest'){
      nf.frequency.value = 1400;
      ng.gain.value = 0.12;
      pf.frequency.value = 1000;
      pad.gain.value = 0.14;
    } else if(env === 'space'){
      nf.frequency.value = 700;
      ng.gain.value = 0.10;
      pf.frequency.value = 650;
      pad.gain.value = 0.16;
      oA.o.frequency.value = 98;
      oB.o.frequency.value = 147;
      oC.o.frequency.value = 196;
    } else { // ocean
      nf.frequency.value = 1150;
      ng.gain.value = 0.14;
      pf.frequency.value = 780;
      pad.gain.value = 0.12;
    }

    // Start
    const t = ctx.currentTime;
    ns.start(t);
    [oA,oB,oC].forEach(x => {
      x.g.gain.setValueAtTime(0.0001, t);
      x.g.gain.exponentialRampToValueAtTime(0.35, t+1.2);
      x.o.start(t);
    });
    lfo.start(t);
    lfo2.start(t);

    // Fade in master
    master.gain.setValueAtTime(0.0001, t);
    master.gain.exponentialRampToValueAtTime(Math.max(0.0001, state.audioVol), t+0.8);

    return {
      master, comp, ns, nf, ng, pad, pf, oA, oB, oC, lfo, lfoGain, lfo2, lfo2Gain,
      stop: () => {
        const now = ctx.currentTime;
        master.gain.cancelScheduledValues(now);
        master.gain.setValueAtTime(Math.max(0.0001, master.gain.value), now);
        master.gain.exponentialRampToValueAtTime(0.0001, now+0.35);
        setTimeout(() => {
          try{ ns.stop(); }catch(e){}
          [oA,oB,oC].forEach(x => { try{x.o.stop();}catch(e){} });
          try{ lfo.stop(); lfo2.stop(); }catch(e){}
          try{ master.disconnect(); }catch(e){}
        }, 420);
      }
    };
  }

  async function audioStart(){
    const ctx = fxEnsure();
    if(!ctx) {
      $('musicStatus').textContent = 'Audio non supportato su questo dispositivo.';
      return;
    }
    if(ctx.state === 'suspended'){
      try{ await ctx.resume(); }catch(e){}
    }
    // rebuild nodes for selected env
    if(state.nodes){
      try{ state.nodes.stop(); }catch(e){}
      state.nodes = null;
    }
    state.nodes = buildAmbient(ctx, state.audioEnv);
    state.audioOn = true;
    $('btnMusicToggle').textContent = '‚è∏';
    $('musicStatus').textContent = 'In riproduzione ‚Ä¢ volume ' + Math.round(state.audioVol*100) + '%';
    $('chipAudio').textContent = 'On';
    save();
  }

  function audioStop(){
    if(state.nodes){
      try{ state.nodes.stop(); }catch(e){}
      state.nodes = null;
    }
    state.audioOn = false;
    $('btnMusicToggle').textContent = '‚ñ∂';
    $('musicStatus').textContent = 'In pausa.';
    $('chipAudio').textContent = 'Off';
    save();
  }

  function audioSetVol(v){
    state.audioVol = Math.min(1, Math.max(0.05, v));
    if(state.nodes && state.nodes.master){
      const ctx = state.audioCtx;
      const now = ctx.currentTime;
      state.nodes.master.gain.cancelScheduledValues(now);
      state.nodes.master.gain.setValueAtTime(Math.max(0.0001, state.nodes.master.gain.value), now);
      state.nodes.master.gain.exponentialRampToValueAtTime(state.audioVol, now+0.15);
    }
    $('musicStatus').textContent = state.audioOn ? ('In riproduzione ‚Ä¢ volume ' + Math.round(state.audioVol*100) + '%') : 'In pausa.';
    save();
  }

  // --- Modal helpers
  const modal = {
    show: (title, sub, html) => {
      $('sheetTitle').textContent = title;
      $('sheetSub').textContent = sub || '';
      $('sheetBody').innerHTML = html;
      $('modalBack').classList.add('show');
      document.body.style.overflow='hidden';
    },
    hide: () => {
      $('modalBack').classList.remove('show');
      document.body.style.overflow='hidden'; // keep single page locked
    }
  };

  function fmtDate(ts){
    const d = new Date(ts);
    return d.toLocaleString('it-IT', {weekday:'short', day:'2-digit', month:'short', hour:'2-digit', minute:'2-digit'});
  }

  // --- Content builders
  function openJournal(){
    const list = state.entries.slice().reverse().map(e => `
      <div class="entry">
        <div class="h"><b>${e.mood}</b><span>${fmtDate(e.ts)}</span></div>
        <p>${escapeHtml(e.note || '')}</p>
      </div>
    `).join('') || `<div class="small">Ancora vuoto. Una riga oggi fa la differenza.</div>`;

    modal.show('Diario', 'Una riga, senza pressione.', `
      <div class="field">
        <label>Come ti senti?</label>
        <div class="seg">
          ${moodTag('Calmo','blue')}
          ${moodTag('Teso','warn')}
          ${moodTag('Stanco','')}
          ${moodTag('Motivato','')}
        </div>
      </div>
      <div class="field" style="margin-top:10px">
        <label>Nota (facoltativa)</label>
        <textarea id="jNote" placeholder="Scrivi solo quello che serve."></textarea>
      </div>
      <div class="row2" style="margin-top:10px">
        <button class="btn primary" id="jSave">Salva</button>
        <button class="btn ghost" id="jExport">Esporta</button>
      </div>
      <div class="divider"></div>
      <div class="small" style="margin-bottom:10px">Ultime note</div>
      <div class="list">${list}</div>
      <div class="divider"></div>
      <button class="btn ghost danger" id="jClear">Svuota diario</button>
    `);

    let chosen = 'Calmo';
    document.querySelectorAll('.tag[data-mood]').forEach(el => {
      el.addEventListener('click', () => {
        document.querySelectorAll('.tag[data-mood]').forEach(x=>x.classList.remove('on'));
        el.classList.add('on');
        chosen = el.dataset.mood;
        fxHaptic(); fxClick();
      });
    });
    const first = document.querySelector('.tag[data-mood]');
    if(first){ first.classList.add('on'); }

    $('jSave').addEventListener('click', () => {
      fxHaptic(); fxSuccess();
      const note = $('jNote').value.trim();
      state.entries.push({ts: Date.now(), mood: chosen, note});
      save();
      updateChips();
      modal.hide();
      setTimeout(openJournal, 220);
    });

    $('jExport').addEventListener('click', () => {
      fxHaptic(); fxClick();
      const blob = new Blob([JSON.stringify(state.entries, null, 2)], {type:'application/json'});
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = 'aura_diario.json';
      a.click();
      URL.revokeObjectURL(url);
    });

    $('jClear').addEventListener('click', () => {
      fxHaptic(14); fxClick();
      if(confirm('Vuoi davvero svuotare il diario?')){
        state.entries = [];
        save();
        updateChips();
        modal.hide();
      }
    });
  }

  function moodTag(label, cls){
    return `<div class="tag ${cls||''}" data-mood="${label}">${label}</div>`;
  }

  function escapeHtml(s){
    return (s||'').replace(/[&<>"']/g, (c)=>({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;' }[c]));
  }

  function openSounds(){
    modal.show('Suoni', 'Scegli un ambiente. Audio sempre morbido.', `
      <div class="small">
        Tutti i suoni sono generati offline (WebAudio) per evitare loop ‚Äúmetallici‚Äù o fischi fissi.
        Se senti qualcosa di strano: abbassa il volume da qui.
      </div>
      <div class="divider"></div>
      <div class="row2">
        <div class="field">
          <label>Ambiente</label>
          <div class="seg" style="margin-top:8px">
            ${envTag('ocean','Onda','blue')}
            ${envTag('rain','Pioggia','')}
            ${envTag('forest','Foresta','')}
            ${envTag('space','Deep Focus','')}
          </div>
        </div>
        <div class="field">
          <label>Volume</label>
          <input id="volRange" type="range" min="5" max="100" value="${Math.round(state.audioVol*100)}" />
          <div class="small" style="margin-top:6px">Consiglio iPhone: 20‚Äì45%.</div>
        </div>
      </div>
      <div class="divider"></div>
      <div class="row2">
        <button class="btn primary" id="sPlay">${state.audioOn ? '‚è∏ Pausa' : '‚ñ∂ Avvia'}</button>
        <button class="btn ghost" id="sStop">‚ñ† Stop</button>
      </div>
      <div class="divider"></div>
      <div class="small">
        Nota: su iPhone l‚Äôaudio pu√≤ partire solo dopo un tocco. Se resta ‚Äúmuto‚Äù, premi di nuovo Play.
      </div>
    `);

    document.querySelectorAll('.tag[data-env]').forEach(el => {
      if(el.dataset.env === state.audioEnv) el.classList.add('on');
      el.addEventListener('click', () => {
        document.querySelectorAll('.tag[data-env]').forEach(x=>x.classList.remove('on'));
        el.classList.add('on');
        state.audioEnv = el.dataset.env;
        $('musicSelect').value = state.audioEnv;
        $('musicName').textContent = 'Ambiente: ' + envLabel(state.audioEnv);
        fxHaptic(); fxClick();
        save();
        if(state.audioOn) audioStart();
      });
    });

    $('volRange').addEventListener('input', (e) => {
      const v = Number(e.target.value)/100;
      audioSetVol(v);
    });

    $('sPlay').addEventListener('click', async () => {
      fxHaptic(); fxClick();
      if(state.audioOn){ audioStop(); $('sPlay').textContent = '‚ñ∂ Avvia'; }
      else { await audioStart(); $('sPlay').textContent = '‚è∏ Pausa'; }
    });

    $('sStop').addEventListener('click', () => {
      fxHaptic(); fxClick();
      audioStop();
      $('sPlay').textContent = '‚ñ∂ Avvia';
    });
  }

  function envTag(key, label, cls){ return `<div class="tag ${cls||''}" data-env="${key}">${label}</div>`; }
  function envLabel(k){
    return k==='ocean'?'Onda':k==='rain'?'Pioggia':k==='forest'?'Foresta':'Deep Focus';
  }

  function openSettings(){
    modal.show('Impostazioni', 'Personalizza AURA senza stress.', `
      <div class="row2">
        <div class="field">
          <label>Feedback vibrazione</label>
          <div class="seg" style="margin-top:8px">
            <div class="tag ${state.haptics?'on':''}" id="setHaptics">Vibrazione</div>
            <div class="tag ${state.tips?'on':''}" id="setTips">Suggerimenti</div>
          </div>
          <div class="small" style="margin-top:8px">iPhone: la vibrazione web potrebbe non essere supportata (ok).</div>
        </div>
        <div class="field">
          <label>Volume effetti (tocchi)</label>
          <input id="fxRange" type="range" min="0" max="100" value="${Math.round(state.fxVol*100)}" />
          <div class="small" style="margin-top:6px">Consiglio: 15‚Äì30%.</div>
        </div>
      </div>
      <div class="divider"></div>
      <div class="small">
        Privacy: tutto resta sul tuo dispositivo. Nessun login, nessun tracking, nessun cloud.
      </div>
    `);

    $('setHaptics').addEventListener('click', () => {
      state.haptics = !state.haptics;
      $('setHaptics').classList.toggle('on', state.haptics);
      fxHaptic(14); fxClick();
      save();
    });
    $('setTips').addEventListener('click', () => {
      state.tips = !state.tips;
      $('setTips').classList.toggle('on', state.tips);
      fxHaptic(); fxClick();
      save();
    });
    $('fxRange').addEventListener('input', (e) => {
      state.fxVol = Number(e.target.value)/100;
      save();
    });
  }

  function openInsight(){
    const items = lastDays(7).map(d => {
      const label = d.toLocaleDateString('it-IT',{weekday:'short', day:'2-digit', month:'short'});
      const n = countEntriesOn(d);
      const mood = topMoodOn(d) || '‚Äî';
      const bar = Math.min(100, n*25);
      return `
        <div class="entry">
          <div class="h"><b>${label}</b><span>${n} note</span></div>
          <div class="small">Mood: <b>${mood}</b></div>
          <div style="margin-top:10px; height:10px; border-radius:999px; background:rgba(255,255,255,.08); overflow:hidden; border:1px solid rgba(255,255,255,.08)">
            <div style="height:100%; width:${bar}%; background:linear-gradient(135deg, rgba(77,140,255,.9), rgba(106,227,180,.25));"></div>
          </div>
        </div>
      `;
    }).join('');

    modal.show('Insight', 'I tuoi pattern (semplici, utili).', `
      <div class="small">
        AURA non ti giudica: ti mostra solo cosa succede. Pi√π note ‚Üí insight pi√π chiari.
      </div>
      <div class="divider"></div>
      <div class="list">
        ${items}
      </div>
      <div class="divider"></div>
      <div class="small">
        Suggerimento: prova a scrivere 1 riga sempre allo stesso orario per 7 giorni.
      </div>
    `);
  }

  function lastDays(n){
    const out=[];
    const now = new Date(); now.setHours(12,0,0,0);
    for(let i=0;i<n;i++){
      const d = new Date(now);
      d.setDate(d.getDate()-i);
      out.push(d);
    }
    return out;
  }
  function sameDay(a,b){ return a.getFullYear()==b.getFullYear() && a.getMonth()==b.getMonth() && a.getDate()==b.getDate(); }
  function countEntriesOn(day){
    return state.entries.filter(e => sameDay(new Date(e.ts), day)).length;
  }
  function topMoodOn(day){
    const m = {};
    state.entries.filter(e => sameDay(new Date(e.ts), day)).forEach(e => m[e.mood]=(m[e.mood]||0)+1);
    let best=null, bestv=0;
    Object.keys(m).forEach(k => { if(m[k]>bestv){bestv=m[k]; best=k;}});
    return best;
  }

  function openRituals(){
    modal.show('Rituali', 'Scegli una direzione. Io ti accompagno.', `
      <div class="small">Tre rituali rapidi. Durano 45‚Äì90 secondi.</div>
      <div class="divider"></div>
      <div class="list">
        ${ritualCard('Calma', 'Rallenta il battito: 4‚Äë4‚Äë6 con audio morbido.', 'calm')}
        ${ritualCard('Focus', 'Sposta l‚Äôattenzione su un compito, senza pressione.', 'focus')}
        ${ritualCard('Energia gentile', 'Attiva con respiro breve e nota positiva.', 'energy')}
      </div>
    `);
    document.querySelectorAll('[data-ritual]').forEach(el => {
      el.addEventListener('click', () => {
        fxHaptic(); fxClick();
        runRitual(el.dataset.ritual);
      });
    });
  }
  function ritualCard(t, d, key){
    return `
      <div class="entry" data-ritual="${key}" style="cursor:pointer">
        <div class="h"><b>${t}</b><span>‚ñ∂ Avvia</span></div>
        <p>${d}</p>
      </div>
    `;
  }

  async function runRitual(kind){
    modal.hide();
    // Mini overlay using native alert-like sheet
    const t0 = Date.now();
    const plan = kind==='focus'
      ? {title:'Focus', seq:[['Inspira',4],['Trattieni',2],['Espira',6]] , rounds:3}
      : kind==='energy'
      ? {title:'Energia gentile', seq:[['Inspira',3],['Espira',3]] , rounds:6}
      : {title:'Calma', seq:[['Inspira',4],['Trattieni',4],['Espira',6]] , rounds:3};

    modal.show(plan.title, 'Segui. Niente fretta.', `
      <div class="small">Durata: ~${Math.round(totalSeconds(plan)/1)}s. Se vuoi, attiva l‚Äôaudio prima.</div>
      <div class="divider"></div>
      <div style="display:grid; place-items:center; padding: 12px 0">
        <div id="ring" style="width:150px;height:150px;border-radius:999px;border:2px solid rgba(255,255,255,.14); background: radial-gradient(circle at 30% 30%, rgba(77,140,255,.22), rgba(255,255,255,.04)); box-shadow: 0 0 0 0 rgba(106,227,180,.0); transition: transform 1s ease, box-shadow 1s ease;"></div>
        <div id="phase" style="margin-top:14px; font-weight:1000; letter-spacing:.5px"></div>
        <div id="timer" style="margin-top:6px; color:var(--muted2); font-size:12px"></div>
      </div>
      <div class="row2">
        <button class="btn primary" id="goNow">‚ñ∂ Parti</button>
        <button class="btn ghost" id="stopNow">Ferma</button>
      </div>
    `);

    let stop=false;
    $('stopNow').addEventListener('click', ()=>{ stop=true; fxHaptic(); fxClick(); modal.hide(); });
    $('goNow').addEventListener('click', async ()=>{
      fxHaptic(); fxClick();
      if(!state.audioOn){
        // don't force audio, but resume ctx to allow FX
        fxEnsure();
      }
      $('goNow').disabled = true;
      await playBreath(plan, () => stop);
      if(!stop){
        fxSuccess(); fxHaptic(18);
        // log quick entry
        state.entries.push({ts: Date.now(), mood: plan.title, note: 'Rituale completato.'});
        save();
        updateChips();
        modal.hide();
      }
    });
  }

  function totalSeconds(plan){
    const perRound = plan.seq.reduce((a,b)=>a+b[1],0);
    return perRound*plan.rounds;
  }

  async function playBreath(plan, isStop){
    const ring = $('ring'); const phase = $('phase'); const timer = $('timer');
    let remaining = totalSeconds(plan);
    timer.textContent = `Durata ~${remaining}s`;
    for(let r=0;r<plan.rounds;r++){
      for(const [label, seconds] of plan.seq){
        if(isStop()) return;
        phase.textContent = label;
        const inhale = (label.toLowerCase().includes('inspira'));
        ring.style.transform = inhale ? 'scale(1.18)' : 'scale(0.92)';
        ring.style.boxShadow = inhale ? '0 0 0 14px rgba(77,140,255,.16)' : '0 0 0 10px rgba(106,227,180,.10)';
        for(let s=0;s<seconds;s++){
          if(isStop()) return;
          await wait(1000);
          remaining--;
          timer.textContent = `Restano ~${remaining}s`;
          // soft haptic pulse at phase transitions only
        }
        fxHaptic(10);
        fxClick();
      }
    }
    phase.textContent = 'Fatto';
    ring.style.transform = 'scale(1)';
    ring.style.boxShadow = '0 0 0 14px rgba(106,227,180,.14)';
  }

  const wait = (ms)=> new Promise(res=>setTimeout(res,ms));

  function openInstallHelp(){
    modal.show('Installazione su iPhone', 'PWA (Home Screen) in 20 secondi.', `
      <div class="small">
        1) Apri il sito in Safari<br/>
        2) Tocca <b>Condividi</b> (quadrato con freccia)<br/>
        3) Seleziona <b>Aggiungi a Home</b><br/>
        4) Apri AURA dall‚Äôicona: modalit√† app, offline-first.
      </div>
      <div class="divider"></div>
      <div class="small">
        Se non vedi ‚ÄúAggiungi a Home‚Äù: scorri le opzioni in basso oppure aggiorna la pagina.
      </div>
    `);
  }

  function openHelp(){
    modal.show('Aiuto', 'Uso rapido.', `
      <div class="small">
        ‚Ä¢ In basso trovi la musica: <b>‚ñ∂</b> avvia, <b>‚â°</b> apre controlli.<br/>
        ‚Ä¢ ‚ÄúRituale 60s‚Äù ti guida in un minuto.<br/>
        ‚Ä¢ ‚ÄúDiario‚Äù salva le note: servono per gli Insight.<br/>
        ‚Ä¢ Tutto resta sul dispositivo.
      </div>
      <div class="divider"></div>
      <button class="btn ghost" id="resetOnb">Rivedi demo iniziale</button>
    `);
    $('resetOnb').addEventListener('click', ()=>{
      localStorage.removeItem('aura.onboarded');
      modal.hide();
      setTimeout(showOnboarding, 150);
    });
  }

  // --- Tips (delicate)
  const tips = [
    'Respira 4‚Äë4‚Äë6 per 60 secondi.',
    'Scegli ‚ÄúOnda‚Äù e abbassa il volume al 30%.',
    'Una nota breve: ‚Äúcosa mi serve adesso?‚Äù.',
    'Micro‚Äëfocus: una cosa sola per 5 minuti.',
    'Spalle gi√π, mascella morbida. Poi respiro.',
  ];
  function maybeTip(){
    if(!state.tips) return;
    const now = Date.now();
    if(now - state.lastTipAt < 1000*60*8) return;
    state.lastTipAt = now;
    $('tipText').textContent = tips[Math.floor(Math.random()*tips.length)];
    save();
  }

  function updateChips(){
    const today = new Date();
    $('chipStreak').textContent = countEntriesOn(today);
    const last = state.entries[state.entries.length-1];
    $('chipState').textContent = last ? last.mood : 'Calmo';
    $('musicName').textContent = 'Ambiente: ' + envLabel(state.audioEnv);
    $('musicSelect').value = state.audioEnv;
    $('chipAudio').textContent = state.audioOn ? 'On' : 'Off';
  }

  // --- Wire UI
  function wire(){
    // Cards
    $('cardSounds').addEventListener('click', ()=>{ fxHaptic(); fxClick(); openSounds(); });
    $('cardInsight').addEventListener('click', ()=>{ fxHaptic(); fxClick(); openInsight(); });
    $('cardRitual').addEventListener('click', ()=>{ fxHaptic(); fxClick(); openRituals(); });
    $('cardSettings').addEventListener('click', ()=>{ fxHaptic(); fxClick(); openSettings(); });

    // Hero buttons
    $('btnStart60').addEventListener('click', ()=>{ fxHaptic(); fxClick(); runRitual('calm'); });
    $('btnBreath').addEventListener('click', ()=>{ fxHaptic(); fxClick(); openRituals(); });
    $('btnJournal').addEventListener('click', ()=>{ fxHaptic(); fxClick(); openJournal(); });

    // Top
    $('btnHelp').addEventListener('click', ()=>{ fxHaptic(); fxClick(); openHelp(); });
    $('btnInstall').addEventListener('click', ()=>{ fxHaptic(); fxClick(); openInstallHelp(); });

    // Modal close
    $('sheetClose').addEventListener('click', ()=>{ fxHaptic(); fxClick(); modal.hide(); });
    $('modalBack').addEventListener('click', (e)=>{ if(e.target.id==='modalBack'){ fxHaptic(); fxClick(); modal.hide(); } });

    // Music
    $('btnMusicToggle').addEventListener('click', async ()=>{
      fxHaptic(); fxClick();
      if(state.audioOn) audioStop();
      else await audioStart();
    });
    $('musicSelect').addEventListener('change', async (e)=>{
      state.audioEnv = e.target.value;
      $('musicName').textContent = 'Ambiente: ' + envLabel(state.audioEnv);
      save();
      fxHaptic(); fxClick();
      if(state.audioOn) await audioStart();
    });
    $('btnMusicMore').addEventListener('click', ()=>{ fxHaptic(); fxClick(); openSounds(); });

    // Gentle periodic tip
    setInterval(maybeTip, 1000*30);
    setTimeout(maybeTip, 1800);
  }

  // --- PWA install prompt (Android/desktop). iOS: show instructions.
  window.addEventListener('beforeinstallprompt', (e)=>{
    e.preventDefault();
    state.installPrompt = e;
  });

  // --- Onboarding
  function showOnboarding(){
    const done = localStorage.getItem('aura.onboarded') === '1';
    if(done) return;
    $('onb').classList.add('show');
  }
  function hideOnboarding(){
    $('onb').classList.remove('show');
    localStorage.setItem('aura.onboarded','1');
  }
  $('onbGo').addEventListener('click', ()=>{ fxHaptic(); fxClick(); hideOnboarding(); });
  $('onbSkip').addEventListener('click', ()=>{ fxHaptic(); fxClick(); hideOnboarding(); });

  // --- SW register
  async function registerSW(){
    if('serviceWorker' in navigator){
      try{
        await navigator.serviceWorker.register('./sw.js', {scope:'./'});
      }catch(e){}
    }
  }

  // Init
  load();
  updateChips();
  wire();
  registerSW();
  showOnboarding();

  // Keep body non-scroll; all content is visible in one page.
  document.body.style.overflow='hidden';
})();
</script>
</body>
</html>
